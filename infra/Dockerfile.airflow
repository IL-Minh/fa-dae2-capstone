FROM apache/airflow:3.0.4

# Install uv
RUN pip install uv

# Set working directory
WORKDIR /opt/airflow

# Copy dependency files
COPY pyproject.toml uv.lock ./

# Install dependencies with uv (frozen for reproducibility)
RUN uv sync --frozen

# Activate uv virtual environment for Airflow
ENV PATH="/opt/airflow/.venv/bin:$PATH"
ENV VIRTUAL_ENV="/opt/airflow/.venv"

# Switch back to airflow user
USER airflow
